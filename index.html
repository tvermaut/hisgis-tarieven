<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <title>Tariefsoorten per Categorie en Naam</title>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css">
    <style>
        body { font-family: Arial, sans-serif; margin: 2em; }
        h1 { margin-bottom: 1em; }
        table { width: 100%; }
    </style>
</head>
<body>
    <h1>Tariefsoorten per Categorie en Naam</h1>
    <p>Deze tabel toont per tariefsoortcategorie en tariefsoortnaam het aantal tariefsoorten.</p>
    <table id="tariefTable" class="display">
        <thead>
            <tr>
                <th>Categorie-id</th>
                <th>Categorie</th>
                <th>Subcategorie</th>
                <th>Tariefsoortnaam</th>
                <th>Aantal tariefsoorten</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>

    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script>
    // Haal alle tariefsoorten paginerend op
    async function fetchAllTariefsoorten() {
        let allRows = [];
        let offset = 0;
        const limit = 1000;
        while (true) {
            const url = `https://oat.hisgis.nl/oat-ws/rest/tabel?tabel=tariefsoort&offset=${offset}`;
            const response = await fetch(url);
            const data = await response.json();
            const rows = (data.tariefsoort || [])
                .filter(item => item.row)
                .map(item => item.row);
            allRows = allRows.concat(rows);
            if (rows.length < limit) break;
            offset += limit;
        }
        return allRows;
    }

    // Haal alle tariefsoortcategorieën op
    async function fetchTariefsoortcategorieen() {
        const url = "https://oat.hisgis.nl/oat-ws/rest/tabel?tabel=tariefsoortcategorie";
        const response = await fetch(url);
        const data = await response.json();
        const rows = (data.tariefsoortcategorie || [])
            .filter(item => item.row)
            .map(item => item.row);
        // id, version, categorie, subcategorie
        return rows.map(r => ({
            id: r[0],
            categorie: r[2],
            subcategorie: r[3]
        }));
    }

    // Groepeer op categorie-id, categorie, subcategorie én tariefsoortnaam
    function aggregateByCategorieAndNaam(tariefsoorten, categorieen) {
        // tariefsoort: id, version, aantal, naam, type, gemeente_id, opmerking, categorie_id
        // categorieen: id, categorie, subcategorie
        // Maak lookup voor categorieën
        const catMap = {};
        for (const cat of categorieen) {
            catMap[String(cat.id)] = cat;
        }
        // Groepeer
        const aggregation = {};
        for (const row of tariefsoorten) {
            const categorie_id = String(row[7]);
            const naam = row[3];
            const cat = catMap[categorie_id] || {categorie: '', subcategorie: ''};
            const key = [categorie_id, cat.categorie, cat.subcategorie, naam].join('||');
            if (!aggregation[key]) {
                aggregation[key] = {
                    categorie_id: categorie_id,
                    categorie: cat.categorie,
                    subcategorie: cat.subcategorie,
                    naam: naam,
                    count: 0
                };
            }
            aggregation[key].count += 1;
        }
        // Zet om naar array
        return Object.values(aggregation).map(obj => [
            obj.categorie_id,
            obj.categorie,
            obj.subcategorie,
            obj.naam,
            obj.count
        ]);
    }

    $(async function() {
        const [tariefsoorten, categorieen] = await Promise.all([
            fetchAllTariefsoorten(),
            fetchTariefsoortcategorieen()
        ]);
        const data = aggregateByCategorieAndNaam(tariefsoorten, categorieen);

        $('#tariefTable').DataTable({
            data: data,
            columns: [
                { title: "Categorie-id" },
                { title: "Categorie" },
                { title: "Subcategorie" },
                { title: "Tariefsoortnaam" },
                { title: "Aantal tariefsoorten" }
            ],
            pageLength: 100,
            order: [[0, 'asc'], [3, 'asc']],
            language: {
                url: "//cdn.datatables.net/plug-ins/1.13.7/i18n/nl-NL.json"
            }
        });
    });
    </script>
</body>
</html>
