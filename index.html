<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <title>Tariefsoorten per Categorie, Gemeente, Provincie en Grondgebruik</title>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css">
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        body {
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            background: #fff;
        }
        #container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            width: 100vw;
            margin: 0;
            padding: 0;
        }
        #airtablebar {
            display: flex;
            align-items: center;
            background: #f4f6fa;
            border-bottom: 1px solid #e0e0e0;
            padding: 6px 12px;
            font-size: 13px;
            gap: 1.5em;
        }
        #airtablebar label {
            margin-right: 0.5em;
        }
        #table-area {
            flex: 1 1 auto;
            min-height: 0;
            min-width: 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        #tariefTable_wrapper {
            flex: 1 1 auto;
            display: flex;
            flex-direction: column;
            height: 100%;
            width: 100%;
        }
        .dataTables_scroll {
            flex: 1 1 auto;
            min-height: 0;
        }
        .dataTables_scrollBody {
            height: 100% !important;
            max-height: 100% !important;
        }
        .dataTables_paginate, .dataTables_info {
            background: #fff;
        }
        .dataTables_filter {
            float: left !important;
            margin-bottom: 0.5em;
        }
        .filter-checkboxes {
            display: inline-block;
            margin-left: 1em;
        }
        .filter-checkboxes label {
            margin-right: 1.5em;
            font-weight: normal;
            font-size: 1em;
            vertical-align: middle;
        }
        .dt-checkbox {
            vertical-align: middle;
            margin-right: 0.3em;
        }
        table.dataTable {
            width: 100% !important;
            margin: 0 !important;
            font-size: 13px;
        }
        .dataTables_wrapper {
            padding: 0 !important;
            margin: 0 !important;
        }
        .dataTables_wrapper .bottom {
            min-height: 48px;
            position: relative;
            z-index: 2;
            background: #fff;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .cat-empty {
            background-color: #ffeaea !important;
        }
        /* Compacte rijen */
        table.dataTable tbody tr {
            height: 24px;
        }
        table.dataTable td, table.dataTable th {
            padding-top: 2px !important;
            padding-bottom: 2px !important;
        }
        #statusbar {
            width: 100vw;
            min-height: 26px;
            background: #f8f8f8;
            color: #333;
            font-size: 13px;
            font-family: monospace;
            border-top: 1px solid #ddd;
            box-sizing: border-box;
            padding: 3px 12px 3px 12px;
            position: fixed;
            bottom: 0;
            left: 0;
            z-index: 100;
            display: flex;
            align-items: center;
        }
        .airtable-dropdown {
            font-size: 13px;
            padding: 2px 6px;
            margin-right: 0.5em;
        }
        .airtablebar-section {
            display: flex;
            align-items: center;
            gap: 0.5em;
        }
    </style>
</head>
<body>
<div id="container">
    <div id="airtablebar">
        <div class="airtablebar-section">
            <label for="groupby">Groepeer op</label>
            <select id="groupby" class="airtable-dropdown">
                <option value="">(geen)</option>
                <option value="provincie">Provincie</option>
                <option value="gemeente">Gemeente</option>
                <option value="categorie">Categorie</option>
                <option value="naam">Tariefsoortnaam</option>
                <option value="grondgebruik">Grondgebruik</option>
            </select>
        </div>
        <div class="airtablebar-section">
            <label for="sortby">Sorteer op</label>
            <select id="sortby" class="airtable-dropdown">
                <option value="provincie">Provincie</option>
                <option value="gemeente">Gemeente</option>
                <option value="categorie">Categorie</option>
                <option value="naam">Tariefsoortnaam</option>
                <option value="grondgebruik">Grondgebruik</option>
                <option value="percelen">Aantal percelen</option>
            </select>
            <select id="sortdir" class="airtable-dropdown">
                <option value="asc">Oplopend</option>
                <option value="desc">Aflopend</option>
            </select>
        </div>
        <div class="airtablebar-section">
            <label for="filterveld">Filter</label>
            <select id="filterveld" class="airtable-dropdown">
                <option value="">(geen)</option>
                <option value="provincie">Provincie</option>
                <option value="gemeente">Gemeente</option>
                <option value="categorie">Categorie</option>
                <option value="naam">Tariefsoortnaam</option>
                <option value="grondgebruik">Grondgebruik</option>
            </select>
            <input type="text" id="filterwaarde" class="airtable-dropdown" placeholder="waarde..." style="width: 120px;">
        </div>
        <span class="filter-checkboxes">
            <label>
                <input type="checkbox" class="dt-checkbox" id="noCatFilter">
                Alleen zonder categorie
            </label>
            <label>
                <input type="checkbox" class="dt-checkbox" id="hasPerceeltariefFilter">
                Alleen met perceeltarieven
            </label>
        </span>
    </div>
    <div id="table-area">
        <table id="tariefTable" class="display" style="width:100%">
            <thead>
                <tr>
                    <th>Provincie</th>
                    <th>Gemeente</th>
                    <th>Categorie</th>
                    <th>Tariefsoortnaam</th>
                    <th>Grondgebruik</th>
                    <th>Aantal percelen</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>
</div>
<div id="statusbar">Status: pagina geladen.</div>
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script>
// Retry helper met exponential backoff (0s, 1s, 3s, 10s)
async function fetchWithRetry(url, label, maxTries = 5) {
    let tries = 0;
    let delays = [0, 1000, 3000, 10000];
    let lastErr = null;
    while (tries < maxTries) {
        try {
            setStatus(`Laden ${label}... poging ${tries+1}`);
            let resp = await fetch(url);
            if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
            return await resp.json();
        } catch (e) {
            lastErr = e;
            let delay = delays[Math.min(tries, delays.length-1)];
            setStatus(`Fout bij laden ${label} (poging ${tries+1}): ${e}. Probeer opnieuw over ${delay/1000}s...`);
            if (tries === maxTries-1) break;
            if (delay > 0) await new Promise(r => setTimeout(r, delay));
        }
        tries++;
    }
    setStatus(`Definitief gestopt met laden van ${label}: ${lastErr}`);
    throw lastErr;
}

function setStatus(msg) {
    document.getElementById('statusbar').textContent = msg;
}

// REST helpers met status en retry
async function fetchPaged(url, key, statusLabel, countCb) {
    let allRows = [];
    let offset = 0;
    const limit = 1000;
    while (true) {
        setStatus(`Laden ${statusLabel}... (${allRows.length} ingeladen)`);
        let data;
        try {
            data = await fetchWithRetry(url + "&offset=" + offset, statusLabel);
        } catch (e) {
            break;
        }
        const rows = (data[key] || [])
            .filter(item => item.row)
            .map(item => item.row);
        allRows = allRows.concat(rows);
        if (typeof countCb === "function") countCb(allRows.length);
        if (rows.length < limit) break;
        offset += limit;
    }
    return allRows;
}

async function fetchAllTariefsoorten() {
    // id, version, aantal, naam, type, gemeente_id, opmerking, categorie_id
    return await fetchPaged("https://oat.hisgis.nl/oat-ws/rest/tabel?tabel=tariefsoort", "tariefsoort", "tariefsoorten");
}
async function fetchTariefsoortcategorieen() {
    // id, version, categorie, subcategorie
    setStatus("Laden tariefsoortcategorieën...");
    let data = await fetchWithRetry("https://oat.hisgis.nl/oat-ws/rest/tabel?tabel=tariefsoortcategorie", "tariefsoortcategorieën");
    return (data.tariefsoortcategorie || [])
        .filter(item => item.row)
        .map(item => ({
            id: item.row[0],
            categorie: item.row[2],
            subcategorie: item.row[3]
        }));
}
async function fetchAllGemeenten() {
    // id, version, code, kadastralecode, naam, oatmodel, uniekenaam, provincie_id, status, opmerking
    return (await fetchPaged("https://oat.hisgis.nl/oat-ws/rest/tabel?tabel=gemeente", "gemeente", "gemeenten"))
        .map(r => ({
            id: r[0],
            uniekenaam: r[6],
            provincie_id: r[7]
        }));
}
async function fetchProvincies() {
    // id, version, code, naam
    setStatus("Laden provincies...");
    let data = await fetchWithRetry("https://oat.hisgis.nl/oat-ws/rest/tabel?tabel=provincie", "provincies");
    return (data.provincie || [])
        .filter(item => item.row)
        .map(item => ({
            id: item.row[0],
            naam: item.row[3]
        }));
}
async function fetchAllTarieven() {
    // id, version, klasse, tarief, tariefsoort_id, opmerking, grondgebruik_id
    return await fetchPaged("https://oat.hisgis.nl/oat-ws/rest/tabel?tabel=tarief", "tarief", "tarieven");
}
async function fetchAllPerceeltarieven(perceeltariefCountCb) {
    // id, version, oppervlak, perceel_id, tarief_id, tariefverwijzing_id, importbatch_id, importcontextnr
    return await fetchPaged("https://oat.hisgis.nl/oat-ws/rest/tabel?tabel=perceeltarief", "perceeltarief", "perceeltarieven", perceeltariefCountCb);
}
async function fetchAllPercelen(perceelCountCb) {
    // id, version, aftrek, belastbaar_inkomen, belastbaar_inkomen_gebouwd, geschrapt, grondgebruik, ...
    return await fetchPaged("https://oat.hisgis.nl/oat-ws/rest/tabel?tabel=perceel", "perceel", "percelen", perceelCountCb);
}

function combineCategorie(cat, subcat) {
    if (cat && subcat) return cat + ": " + subcat;
    if (cat) return cat;
    if (subcat) return subcat;
    return "";
}

function aggregateData(
    tariefsoorten, categorieen, gemeenten, provincies,
    tarieven, perceeltarieven, percelen
) {
    const catMap = {};
    categorieen.forEach(cat => { catMap[String(cat.id)] = cat; });
    const gemeenteMap = {};
    gemeenten.forEach(gem => { gemeenteMap[String(gem.id)] = gem; });
    const provincieMap = {};
    provincies.forEach(prov => { provincieMap[String(prov.id)] = prov.naam; });
    // tariefsoort.id -> tarief.id[]
    const tariefsoort2tarieven = {};
    tarieven.forEach(tarief => {
        // tarief: id, version, klasse, tarief, tariefsoort_id, opmerking, grondgebruik_id
        const tariefsoort_id = String(tarief[4]);
        if (!tariefsoort2tarieven[tariefsoort_id]) tariefsoort2tarieven[tariefsoort_id] = [];
        tariefsoort2tarieven[tariefsoort_id].push(tarief[0]);
    });
    // tarief.id -> perceeltarief[]
    const tarief2perceeltarieven = {};
    perceeltarieven.forEach(pt => {
        // perceeltarief: id, version, oppervlak, perceel_id, tarief_id, tariefverwijzing_id, importbatch_id, importcontextnr
        const tarief_id = String(pt[4]);
        if (!tarief2perceeltarieven[tarief_id]) tarief2perceeltarieven[tarief_id] = [];
        tarief2perceeltarieven[tarief_id].push(pt);
    });
    // perceel.id -> grondgebruik
    const perceelId2grondgebruik = {};
    percelen.forEach(perceel => {
        // perceel: id, version, aftrek, belastbaar_inkomen, belastbaar_inkomen_gebouwd, geschrapt, grondgebruik, ...
        perceelId2grondgebruik[String(perceel[0])] = perceel[6];
    });

    // Aggregatie
    // key: provincie, gemeente, categorie, naam, grondgebruik
    // waarde: {provincie, gemeente, categorie, naam, grondgebruik, perceelIds(Set), hasNoCat, hasPerceeltarief}
    const aggregation = {};
    for (const row of tariefsoorten) {
        // id, version, aantal, naam, type, gemeente_id, opmerking, categorie_id
        const id = String(row[0]);
        const naam = row[3];
        const gemeente_id = row[5] !== undefined && row[5] !== null && row[5] !== "" ? String(row[5]) : null;
        const categorie_id = row[7] !== undefined && row[7] !== null && row[7] !== "" ? String(row[7]) : null;
        const opmerking = row[6];
        // Filter 'polder' opmerkingen
        if (opmerking && typeof opmerking === "string" && opmerking.trim().toLowerCase().startsWith('polder')) continue;
        // Gemeente, provincie, categorie
        let gemeente = gemeente_id && gemeenteMap[gemeente_id] ? gemeenteMap[gemeente_id] : null;
        let gemeenteNaam = gemeente ? gemeente.uniekenaam : "";
        let provincieNaam = (gemeente && gemeente.provincie_id && provincieMap[gemeente.provincie_id]) ? provincieMap[gemeente.provincie_id] : "";
        let cat = categorie_id && catMap[categorie_id] ? catMap[categorie_id] : null;
        let catLabel = cat ? combineCategorie(cat.categorie, cat.subcategorie) : "";
        let hasNoCat = !categorie_id;
        // Alle tarief.id's voor deze tariefsoort
        let tariefIds = tariefsoort2tarieven[id] || [];
        // Verzamel alle perceel_ids via tarief -> perceeltarief
        let perceelIds = [];
        for (const tariefId of tariefIds) {
            const pts = tarief2perceeltarieven[tariefId] || [];
            for (const pt of pts) {
                // pt: id, version, oppervlak, perceel_id, tarief_id, ...
                if (pt[3] !== undefined && pt[3] !== null && pt[3] !== "") {
                    perceelIds.push(String(pt[3]));
                }
            }
        }
        // Groepeer per grondgebruik
        const grondgebruik2percelen = {};
        for (const perceelId of perceelIds) {
            const grondgebruik = perceelId2grondgebruik[perceelId] || "";
            if (!grondgebruik2percelen[grondgebruik]) grondgebruik2percelen[grondgebruik] = new Set();
            grondgebruik2percelen[grondgebruik].add(perceelId);
        }
        // Als er geen percelen zijn, toch een groep aanmaken met lege grondgebruik
        if (Object.keys(grondgebruik2percelen).length === 0) {
            const key = [provincieNaam, gemeenteNaam, catLabel, naam, ""].join('||');
            if (!aggregation[key]) {
                aggregation[key] = {
                    provincie: provincieNaam,
                    gemeente: gemeenteNaam,
                    categorie: catLabel,
                    naam: naam,
                    grondgebruik: "",
                    perceelIds: new Set(),
                    hasNoCat: hasNoCat,
                    hasPerceeltarief: false
                };
            }
        } else {
            for (const [grondgebruik, percelenSet] of Object.entries(grondgebruik2percelen)) {
                const key = [provincieNaam, gemeenteNaam, catLabel, naam, grondgebruik].join('||');
                if (!aggregation[key]) {
                    aggregation[key] = {
                        provincie: provincieNaam,
                        gemeente: gemeenteNaam,
                        categorie: catLabel,
                        naam: naam,
                        grondgebruik: grondgebruik,
                        perceelIds: new Set(),
                        hasNoCat: hasNoCat,
                        hasPerceeltarief: false
                    };
                }
                percelenSet.forEach(pid => aggregation[key].perceelIds.add(pid));
                aggregation[key].hasPerceeltarief = true;
            }
        }
    }
    return Object.values(aggregation).map(obj => [
        obj.provincie,
        obj.gemeente,
        obj.categorie,
        obj.naam,
        obj.grondgebruik,
        obj.perceelIds.size,
        obj.hasNoCat,
        obj.hasPerceeltarief
    ]);
}

// Airtable-achtige groepering, sortering, filtering
function applyAirtableControls(table, origData) {
    function getColIdx(field) {
        return {
            provincie: 0,
            gemeente: 1,
            categorie: 2,
            naam: 3,
            grondgebruik: 4,
            percelen: 5
        }[field];
    }
    function updateTable() {
        let data = origData.slice();
        // Filter
        let filterField = $('#filterveld').val();
        let filterWaarde = $('#filterwaarde').val().toLowerCase();
        if (filterField && filterWaarde) {
            let idx = getColIdx(filterField);
            data = data.filter(row => (row[idx]||"").toString().toLowerCase().includes(filterWaarde));
        }
        // Checkboxes
        if (window.filterNoCatActive) data = data.filter(row => row[2] === "");
        if (window.filterPerceeltariefActive) data = data.filter(row => row[7]);
        // Groeperen
        let groupField = $('#groupby').val();
        if (groupField) {
            let idx = getColIdx(groupField);
            // Sorteren op groepveld
            data.sort((a,b) => (a[idx]||"").localeCompare(b[idx]||""));
            // Voeg group header rows toe
            let grouped = [];
            let lastVal = null;
            data.forEach(row => {
                if (row[idx] !== lastVal) {
                    grouped.push({isGroup: true, value: row[idx], field: groupField});
                    lastVal = row[idx];
                }
                grouped.push(row);
            });
            data = grouped;
        }
        // Sorteren
        let sortField = $('#sortby').val();
        let sortDir = $('#sortdir').val();
        if (sortField) {
            let idx = getColIdx(sortField);
            data.sort((a,b) => {
                let va = (a.isGroup ? "" : a[idx]||"");
                let vb = (b.isGroup ? "" : b[idx]||"");
                if (sortDir === "asc") return va.localeCompare(vb, undefined, {numeric:true});
                else return vb.localeCompare(va, undefined, {numeric:true});
            });
        }
        // Herladen
        table.clear();
        data.forEach(row => {
            if (row.isGroup) {
                let colspan = table.columns().header().length;
                table.row.add([`<strong style="color:#2d7ff9;">${row.field}: ${row.value || "(leeg)"}</strong>`].concat(Array(colspan-1).fill("")));
            } else {
                table.row.add(row.slice(0,6));
            }
        });
        table.draw(false);
    }
    $('#groupby,#sortby,#sortdir,#filterveld,#filterwaarde').on('change keyup', updateTable);
    $('#noCatFilter,#hasPerceeltariefFilter').on('change', updateTable);
    updateTable();
}

$(async function() {
    let perceelCount = 0;
    let perceeltariefCount = 0;
    function updateStatusLoading() {
        setStatus(`Laden... percelen: ${perceelCount}, perceeltarieven: ${perceeltariefCount}`);
    }

    setStatus("Laden tariefsoorten...");
    const tariefsoorten = await fetchAllTariefsoorten();
    const categorieen = await fetchTariefsoortcategorieen();
    const gemeenten = await fetchAllGemeenten();
    const provincies = await fetchProvincies();
    const tarieven = await fetchAllTarieven();
    const perceeltarieven = await fetchAllPerceeltarieven(count => {
        perceeltariefCount = count;
        updateStatusLoading();
    });
    const percelen = await fetchAllPercelen(count => {
        perceelCount = count;
        updateStatusLoading();
    });

    setStatus("Aggregatie van gegevens...");
    const data = aggregateData(
        tariefsoorten, categorieen, gemeenten, provincies,
        tarieven, perceeltarieven, percelen
    );
    setStatus(`Gereed! Percelen: ${perceelCount}, perceeltarieven: ${perceeltariefCount}`);

    // DataTables filter (voor paginering)
    $.fn.dataTable.ext.search.push(function(settings, searchData, index, rowData, counter) {
        // Laat alles door, filtering gebeurt in airtable-controls
        return true;
    });

    let table = $('#tariefTable').DataTable({
        data: [],
        columns: [
            { title: "Provincie" },
            { title: "Gemeente" },
            { title: "Categorie",
              createdCell: function(td, cellData, rowData, row, col) {
                  if (!cellData || cellData === "") {
                      $(td).addClass('cat-empty').html('∅');
                  }
              }
            },
            { title: "Tariefsoortnaam" },
            { title: "Grondgebruik" },
            { title: "Aantal percelen", className: "dt-right" }
        ],
        pageLength: 100,
        order: [[0, 'asc'], [1, 'asc']],
        language: {
            url: "//cdn.datatables.net/plug-ins/1.13.7/i18n/nl-NL.json"
        },
        autoWidth: false,
        scrollY: 'calc(100vh - 200px)',
        scrollCollapse: true,
        paging: true,
        dom: '<"top"f>rt<"bottom"ip><"clear">'
    });

    // Airtable-achtige controls
    applyAirtableControls(table, data);
});
</script>
</body>
</html>
