<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <title>Tariefsoorten per Categorie en Naam</title>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css">
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        body {
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            background: #fff;
        }
        #container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            width: 100vw;
            margin: 0;
            padding: 0;
        }
        #table-area {
            flex: 1 1 auto;
            min-height: 0;
            min-width: 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        #tariefTable_wrapper {
            flex: 1 1 auto;
            display: flex;
            flex-direction: column;
            height: 100%;
            width: 100%;
        }
        .dataTables_scroll {
            flex: 1 1 auto;
            min-height: 0;
        }
        .dataTables_scrollBody {
            height: 100% !important;
            max-height: 100% !important;
        }
        .dataTables_paginate, .dataTables_info {
            background: #fff;
        }
        .dataTables_filter {
            float: left !important;
            margin-bottom: 0.5em;
        }
        #noCatFilterLabel {
            display: inline-block;
            margin-left: 1em;
            font-weight: normal;
            font-size: 1em;
            vertical-align: middle;
        }
        .dt-checkbox {
            vertical-align: middle;
            margin-right: 0.3em;
        }
        table.dataTable {
            width: 100% !important;
            margin: 0 !important;
        }
        .dataTables_wrapper {
            padding: 0 !important;
            margin: 0 !important;
        }
        /* Reserveer ruimte voor paginering */
        .dataTables_wrapper .bottom {
            min-height: 48px;
            position: relative;
            z-index: 2;
            background: #fff;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
    </style>
</head>
<body>
<div id="container">
    <div id="table-area">
        <table id="tariefTable" class="display" style="width:100%">
            <thead>
                <tr>
                    <th>Categorie-id</th>
                    <th>Categorie</th>
                    <th>Tariefsoortnaam</th>
                    <th>Gemeente</th>
                    <th>Aantal tariefsoorten</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>
</div>
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script>
async function fetchAllTariefsoorten() {
    let allRows = [];
    let offset = 0;
    const limit = 1000;
    while (true) {
        const url = `https://oat.hisgis.nl/oat-ws/rest/tabel?tabel=tariefsoort&offset=${offset}`;
        const response = await fetch(url);
        const data = await response.json();
        const rows = (data.tariefsoort || [])
            .filter(item => item.row)
            .map(item => item.row);
        allRows = allRows.concat(rows);
        if (rows.length < limit) break;
        offset += limit;
    }
    return allRows;
}

async function fetchTariefsoortcategorieen() {
    const url = "https://oat.hisgis.nl/oat-ws/rest/tabel?tabel=tariefsoortcategorie";
    const response = await fetch(url);
    const data = await response.json();
    const rows = (data.tariefsoortcategorie || [])
        .filter(item => item.row)
        .map(item => item.row);
    // id, version, categorie, subcategorie
    return rows.map(r => ({
        id: r[0],
        categorie: r[2],
        subcategorie: r[3]
    }));
}

async function fetchAllGemeenten() {
    let allRows = [];
    let offset = 0;
    const limit = 1000;
    while (true) {
        const url = `https://oat.hisgis.nl/oat-ws/rest/tabel?tabel=gemeente&offset=${offset}`;
        const response = await fetch(url);
        const data = await response.json();
        const rows = (data.gemeente || [])
            .filter(item => item.row)
            .map(item => item.row);
        allRows = allRows.concat(rows);
        if (rows.length < limit) break;
        offset += limit;
    }
    // id, version, code, kadastralecode, naam, oatmodel, uniekenaam, provincie_id, status, opmerking
    return allRows.map(r => ({
        id: r[0],
        uniekenaam: r[6]
    }));
}

function combineCategorie(cat, subcat) {
    if (cat && subcat) return cat + ": " + subcat;
    if (cat) return cat;
    if (subcat) return subcat;
    return "";
}

function aggregateByCategorieAndNaam(tariefsoorten, categorieen, gemeenten) {
    // tariefsoort: id, version, aantal, naam, type, gemeente_id, opmerking, categorie_id
    // categorieen: id, categorie, subcategorie
    // gemeenten: id, uniekenaam
    const catMap = {};
    for (const cat of categorieen) {
        catMap[String(cat.id)] = cat;
    }
    const gemeenteMap = {};
    for (const gem of gemeenten) {
        gemeenteMap[String(gem.id)] = gem.uniekenaam;
    }
    const aggregation = {};
    for (const row of tariefsoorten) {
        // Filter 'polder' opmerkingen
        const opmerking = row[6];
        if (opmerking && typeof opmerking === "string" && opmerking.trim().toLowerCase().startsWith('polder')) continue;
        const categorie_id = row[7] !== undefined && row[7] !== null && row[7] !== "" ? String(row[7]) : null;
        const naam = row[3];
        const gemeente_id = row[5] !== undefined && row[5] !== null && row[5] !== "" ? String(row[5]) : null;
        let cat = categorie_id && catMap[categorie_id] ? catMap[categorie_id] : null;
        let catLabel = cat ? combineCategorie(cat.categorie, cat.subcategorie) : "";
        let catIdDisplay = categorie_id ? categorie_id : "∅";
        let gemeenteNaam = gemeente_id && gemeenteMap[gemeente_id] ? gemeenteMap[gemeente_id] : "";
        let key = [catIdDisplay, catLabel, naam, gemeenteNaam].join('||');
        if (!aggregation[key]) {
            aggregation[key] = {
                categorie_id: catIdDisplay,
                categorie: catLabel,
                naam: naam,
                gemeente: gemeenteNaam,
                count: 0,
                hasNoCat: !categorie_id
            };
        }
        aggregation[key].count += 1;
    }
    return Object.values(aggregation).map(obj => [
        obj.categorie_id,
        obj.categorie,
        obj.naam,
        obj.gemeente,
        obj.count,
        obj.hasNoCat // voor filter
    ]);
}

$(async function() {
    const [tariefsoorten, categorieen, gemeenten] = await Promise.all([
        fetchAllTariefsoorten(),
        fetchTariefsoortcategorieen(),
        fetchAllGemeenten()
    ]);
    const data = aggregateByCategorieAndNaam(tariefsoorten, categorieen, gemeenten);

    // Voeg de checkbox toe naast het zoekveld
    $.fn.dataTable.ext.search.push(function(settings, searchData, index, rowData, counter) {
        if (window.filterNoCatActive) {
            // Laat alleen rijen zien zonder categorie (categorie-id === ∅)
            return rowData[0] === "∅";
        }
        return true;
    });

    // Init DataTable
    let table = $('#tariefTable').DataTable({
        data: data,
        columns: [
            { title: "Categorie-id" },
            { title: "Categorie" },
            { title: "Tariefsoortnaam" },
            { title: "Gemeente" },
            { title: "Aantal tariefsoorten", className: "dt-right" }
        ],
        pageLength: 100,
        order: [[0, 'asc'], [2, 'asc']],
        language: {
            url: "//cdn.datatables.net/plug-ins/1.13.7/i18n/nl-NL.json"
        },
        autoWidth: false,
        scrollY: 'calc(100vh - 140px)',
        scrollCollapse: true,
        paging: true,
        dom: '<"top"f>rt<"bottom"ip><"clear">'
    });

    // Voeg checkbox toe naast het zoekveld
    let filterDiv = $('#tariefTable_filter');
    filterDiv.append(
        `<label id="noCatFilterLabel">
            <input type="checkbox" class="dt-checkbox" id="noCatFilter">
            Alleen zonder categorie
        </label>`
    );

    window.filterNoCatActive = false;
    $('#noCatFilter').on('change', function() {
        window.filterNoCatActive = this.checked;
        table.draw();
    });
});
</script>
</body>
</html>
